<link rel="import" href="../polymer/polymer.html">
<!--
`particle-party`
A configurable particle burst. For parties.

@demo demo/index.html
-->
<dom-module id="particle-party">
<template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div id="particles"></div>
</template>
<script>
    Polymer({
        is: 'particle-party',
        properties: {
            numberParticles: {
                type: Number,
                value: 30,
                reflectToAttribute: true
            },
            gravity: {
                type: Number,
                value: 0.3,
                reflectToAttribute: true
            },
            particleDecay: {
                type: Number,
                value: 0.02,
                reflectToAttribute: true
            },
        },
        listeners: {
            'fireAnimation': 'triggerParticles'
        },
        triggerParticles: function(){
            var offsets = this.$.particles.getBoundingClientRect();
            this.generateParticles(
                offsets.left + window.scrollX + (offsets.width / 2),
                offsets.top + window.scrollY + (offsets.height / 2)
            );
        },
        particles: [],
        idCount: 0,
        origin: {
            x: 0,
            y: 0
        },
        svgWrap: {
            width: 600,
            height: 300
        },
        generateParticles: function(_x, _y) {
            //this.toggleClass('burst', true, this.$.particles);
            var x = _x,
                y = _y,
                svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("height", this.svgWrap.width);
            svg.setAttribute("width", this.svgWrap.height);
            svg.setAttribute("style", "position: absolute; top: " + (y - (this.svgWrap.width / 2)) + "; left: " + (x - (this.svgWrap.height / 2)) + ";");
            svg.setAttribute("id", "outer" + this.idCount);
            for (var i = 0; i < this.numberParticles; i++) {
                var radius = Math.random() * 10;
                var newParticle = {
                    x: -radius,
                    y: -radius,
                    r: radius,
                    dx: Math.random() * 6 - 3,
                    dy: Math.random() * -10,
                    color: '#' + Math.floor(Math.random() * 77215 + 16700000).toString(16),
                    id: this.idCount,
                    scale: 1
                }
                this.particles.push(newParticle);
                var circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", newParticle.r);
                circle.setAttribute("cy", newParticle.r);
                circle.setAttribute("r", newParticle.r);
                circle.setAttribute("fill", newParticle.color);
                circle.setAttribute("id", "inner" + this.idCount);
                svg.appendChild(circle);
                document.body.appendChild(svg);
                this.idCount++;
            }
            this.animateTick();
        },
        animateTick: function() {
            var particles = this.particles;
            if (particles.length > 0) {
                requestAnimationFrame(this.animateTick.bind(this));
            }
            for (var i = 0; i < particles.length; i++) {
                p = particles[i];
                var inner = document.getElementById('inner' + p.id);
                inner.setAttribute("transform", "translate(" + (p.x + (this.svgWrap.height / 2)) + ", " + (p.y + (this.svgWrap.width / 2)) + ") scale(" + p.scale + ", " + p.scale + ")");
                p.x += p.dx;
                p.y += p.dy;
                p.dy += this.gravity;
                if (p.scale > 0.1) {
                    p.scale -= this.particleDecay;
                } else {
                    particles.splice(i, 1);
                    var outer = inner.parentElement;
                    inner.remove();
                    if (!outer.hasChildNodes()) {
                        outer.remove();
                    }
                }
            }
        },
        // attached: function() {
        //     var offsets = this.$.particles.getBoundingClientRect();
        //     // this.toggleClass('burst', false, this.$.particles);
        //     this.generateParticles(
        //         offsets.left + window.scrollX + (offsets.width / 2),
        //         offsets.top + window.scrollY + (offsets.height / 2)
        //     );
        // }
    });
</script>
</dom-module>
